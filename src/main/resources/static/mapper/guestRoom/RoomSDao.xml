<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.goodsoft.hotel.domain.dao.guestRoom.RoomSDao">

    <!--主页面房态信息 start-->

    <!--房态 主页面 获取楼层信息-->
    <select id="queryFloorMapper" resultType="com.goodsoft.hotel.domain.entity.guestRoom.Floors">
        select DISTINCT b.FLOORCODE,b.FLOORNAME,b.FLOORID FROM gs_room a,gs_floor b where  a.FLOORCODE=b.FLOORCODE AND b.FLOORNAME !='业主自用房' ORDER BY b.FLOORID
    </select>


    <!--房态 主页面 通过楼层号获取房间信息-->
    <select id="queryFloorRoomMapper" parameterType="java.util.Map"
            resultType="java.util.Map">
      select a.*,b.* from (
      select b.buildingname,c.floorname,d.typename,d.houseprices,a.id,a.roomno,a.roomtype,a.buildingcode,a.floorcode,a.stdpax,a.maxpax,a.doorlockid,a.flag,a.sflag
      from gs_room a ,gs_building b,gs_floor c,gs_roomtype d
      where a.buildingcode=b.buildingcode and a.floorcode =c.floorcode and a.roomtype=d.roomtype ) a
      left join
      (
      select  a.guestname,a.startdate,a.enddate,a.teamname,a.remark,b.roomid from gs_quickbooking a,gs_quickbooking_roomno b  where a.id=b.bookid and a.startdate = date_format(now(),'%y-%m-%d')
      )b
      on a.id =b.roomid
    </select>


    <!--房态右边下拉框 获取楼层名-->
    <select id="findFloorAllMapper" resultType="com.goodsoft.hotel.domain.entity.guestRoom.Floors">
        select floorCode,floorName FROM gs_floor
    </select>

    <!--房态右边下拉框楼层名获取房间信息 显示到左边-->
    <select id="findFloorNameGetRoomMapper" parameterType="java.lang.String" resultType="java.util.Map">
        SELECT * FROM
        (select id,roomNo,doorlockId,remark,flag,sFlag from gs_room
        where floorcode=#{floorcode} AND floorcode!='202'
        ) x
        LEFT JOIN
        (SELECT a.guestName,a.startDate,a.endDate,b.roomId FROM gs_quickbooking a,gs_quickbooking_roomno b WHERE a.id = b.bookid AND
        unix_timestamp(NOW()) &lt;  unix_timestamp(a.enddate) AND
        unix_timestamp(NOW())  &gt; unix_timestamp(a.startdate)) y
        ON x.id = y.roomid
    </select>

    <!--房态:右边下拉框 获取房间类型 -->
    <select id="queryRoomTypeMapper" resultType="com.goodsoft.hotel.domain.entity.guestRoom.RoomType">
        SELECT * from gs_roomtype
    </select>

    <!--房态:右边下拉框 通过房间类型 获取房间信息-->
    <select id="queryRoomTypeGetRoomMapper" parameterType="java.lang.String" resultType="java.util.Map">
        SELECT * FROM
        (select id,roomNo,doorlockId,remark,flag,sFlag from gs_room
        where roomtype=#{roomType} AND floorcode!='202'
        ) x
        LEFT JOIN
        (SELECT a.guestName,a.startDate,a.endDate,b.roomId FROM gs_quickbooking a,gs_quickbooking_roomno b WHERE a.id = b.bookid AND
        unix_timestamp(NOW()) &lt;  unix_timestamp(a.enddate) AND
        unix_timestamp(NOW())  &gt; unix_timestamp(a.startdate)) y
        ON x.id = y.roomid
    </select>

    <!--房态右边查询-->
    <select id="queryFuzzyRoomMapper" parameterType="java.lang.String" resultType="java.util.Map">
        SELECT * FROM
        (select id,roomNo,doorlockId,remark,flag,sFlag from gs_room
        where  floorcode!='202'
        ) x
        LEFT JOIN
        (SELECT a.guestName,a.startDate,a.endDate,b.roomId FROM gs_quickbooking a,gs_quickbooking_roomno b WHERE a.id = b.bookid AND
         unix_timestamp(NOW()) &lt;  unix_timestamp(a.enddate) and
        a.guestName LIKE CONCAT(CONCAT('%', #{0}), '%')
        OR a.bookingNo LIKE CONCAT(CONCAT('%', #{0}), '%')
        OR a.remark LIKE CONCAT(CONCAT('%', #{0}), '%')
        ) y
        ON x.id = y.roomid
    </select>

    <!--主界面房态信息   end-->

    <!--***************************************************我是分割线***************************************************-->

    <!--快速预定房间信息start-->

    <!--快速预定的房态,左边的列表选择-->
    <select id="queryRoomALLMapper" resultType="java.util.Map">
        select a.ID,a.typeId,a.ROOMTYPE,a.TYPENAME, case when b.price is null then a.HOUSEPRICES else b.price end  HOUSEPRICES,a.roomSum  from (
        SELECT a.ID,a.typeId,a.ROOMTYPE,a.TYPENAME,a.HOUSEPRICES,COUNT(b.FLAG) roomSum FROM gs_roomtype a,gs_room b
        where a.typeid=b.ROOMTYPE AND b.FLAG='空房' GROUP BY a.typeid) a
        left join REALTIMEHOUSEPRICE b on a.typeid=b.typeid and b.time=DATE_FORMAT(NOW(),'%Y-%m-%d')
    </select>

    <!--根据房间类型id获取房间号-->
    <select id="selectKongMapper" resultType="java.util.Map">
        select a.id,a.roomid,a.ROOMNO,a.doorLockId,case when b.price is null then a.housePrices else b.price end housePrices ,a.typename,a.typeid from (
        SELECT a.id,a.roomid,a.ROOMNO,a.doorLockId,b.housePrices,b.typename,b.typeid FROM gs_room a,gs_roomtype b where
        a.ROOMTYPE=b.typeid AND a.FLAG='空房' and b.typename!='不可用'
        AND b.typeId IN
        <foreach collection="list" index="index" item="str" open="(" separator="," close=")">
            #{str}
        </foreach>
        ) a
        left join REALTIMEHOUSEPRICE b on a.typeid=b.typeid and b.time=date_format(now(),'%Y-%m-%d')

    </select>

    <!--快速预定房间信息 end-->

    <!--***************************************************我是分割线***************************************************-->

    <!--快速分房接口Start-->

    <!--右边第一个房间类型-->
    <select id="findRoomTypeFenFangMapper" resultType="com.goodsoft.hotel.domain.entity.guestRoom.RoomType">
        select * FROM gs_roomtype
    </select>

    <!--右边第二个建筑楼层-->
    <select id="findBuildingFenFangMapper" parameterType="java.lang.String" resultType="com.goodsoft.hotel.domain.entity.guestRoom.Building">
        select DISTINCT a.* FROM gs_building a,gs_room b WHERE a.buildingcode = b.buildingcode
            AND b.roomType = #{_parameter}
    </select>

    <!--右边第三个获取楼层-->
    <select id="findFloorsFenFangMapper" parameterType="java.lang.String" resultType="com.goodsoft.hotel.domain.entity.guestRoom.Floors">
        select DISTINCT a.* FROM gs_floor a,gs_room b WHERE a.floorcode = b.floorcode
            AND b.buildingcode = #{_parameter}
    </select>
    
    <!--左边房间查询房间-->
    <select id="findRoomFenFangMapper" parameterType="java.util.Map" resultType="java.util.Map" >
        select * from
        (
        SELECT c.buildingname,d.floorname,b.typename,a.id,a.roomno,a.remark,a.flag,a.sflag from gs_room a,gs_roomtype b,gs_building c ,gs_floor d
        WHERE a.roomtype=b.roomtype AND a.buildingcode = c.buildingcode AND a.floorcode = d.floorcode AND
        <if test="roomType != null and roomType !='' ">
            AND a.roomType = #{roomType}
        </if>
        <if test="buildingCode !=null and buildingCode !='' ">
            AND a.buildingCode=#{buildingCode}
        </if>
        <if test="floorCode !=null and floorCode !='' ">
            AND a.floorCode = #{floorCode}
        </if>
        <if test="flag !=null and flag !='' ">
            and a.flag= #{flag}
        </if>
        <if test="sflag != null and flag != '' ">
            and a.sflag= #{sflag}
        </if>
        ) x
        LEFT JOIN
        (
        select w.roomid,q.bookingno,q.guestname,q.markets,q.salesman,q.startdate,q.enddate,q.releasetime,q.days,q.remark,w.roomno
        from gs_quickbooking q ,gs_quickbooking_roomno w where q.id = w.bookid
        <if test="startDate !=null and startDate != ''">
            AND unix_timestamp(q.startdate) &gt;= unix_timestamp(#{endDate})
        </if>
        <if test="endDate !=null and endDate != '' ">
            and unix_timestamp(q.enddate) &lt;= unix_timestamp(#{endDate})
        </if>
        ) y
        ON x.roomno = y.roomid
    </select>
    <!--快速分房接口end-->


    <!--***************************************************我是分割线***************************************************-->


    <!--建筑添加信息-->
    <insert id="insertBuild" parameterType="com.goodsoft.hotel.domain.entity.guestRoom.Building">
        INSERT INTO gs_building(ID,BUILDINGCODE,BUILDINGNAME) VALUES(#{ID},#{buildingCode},#{buildingName})
    </insert>

    <!--楼层添加信息-->
    <insert id="insertFloor" parameterType="com.goodsoft.hotel.domain.entity.guestRoom.Floors">
        INSERT INTO gs_floor(ID,FLOORCODE,FLOORNAME) VALUES(#{id},#{floorCode},#{floorName})
    </insert>

    <!--添加房间类型名称-->
    <insert id="insertRoomType" parameterType="com.goodsoft.hotel.domain.entity.guestRoom.RoomType">
        insert into gs_roomtype(ID,ROOMTYPE,TYPENAME,HOUSEPRICES) VALUES(#{id},#{roomType},#{typeName},#{housePrices})
    </insert>


    <!--暂时没用到的接口,添加房间信息详情-->
    <insert id="insertRoom" parameterType="com.goodsoft.hotel.domain.entity.guestRoom.Room">
        INSERT INTO gs_room(ID,ROOMTYPE,ROOMNO,CNAME,BUILDINGCODE,FLOORCODE,HOUSEPRICES,NIGHTS,STDPAX,MAXPAX,STATUS,DOORLOCKID,REMARK,FLAG,RACKPATE,RATECODE) VALUES
        (#{id},#{roomType},#{roomNo},#{cName},#{buildingCode},#{floorCode},#{housePrices},#{nights},#{stdPax},#{maxPax},#{status},#{doorLockId},#{remark},#{flag},#{rackRate},#{rateCode})
    </insert>



    <!--添加房价信息-->
    <insert id="addRoomPricesMapper" parameterType="com.goodsoft.hotel.domain.entity.guestRoom.RoomPrices">
        insert INTO gs_roomprices VALUES (#{id},#{roomTypeId},#{setStartTime},#{roomPrices})
    </insert>



    <!--添加实时房价-->
    <insert id="insertRoomRealTimePrice" parameterType="java.util.List">
        insert into REALTIMEHOUSEPRICE values
        <foreach collection="list" item="item" separator=",">
            ('',#{item.typeid},#{item.time},#{item.price})
        </foreach>
</insert>


    <resultMap id="realTimePriceMap" type="com.goodsoft.hotel.domain.entity.guestRoom.RealTimeRoomPrice">
           <result property="id" column="typename"/>
           <result property="typeid" column="typeid"/>
           <result property="time" column="time"/>
           <result property="price" column="price"/>
    </resultMap>
    <!--查询实时房价设置-->
    <select id="selectRoomRealTimePrice" parameterType="string" resultMap="realTimePriceMap">
        select a.typeid,b.typename,a.time,a.price from REALTIMEHOUSEPRICE a,GS_ROOMTYPE b  where a.typeid=b.typeId and time &gt;=DATE_FORMAT(NOW(),'%Y-%m-%d')
        <if test="time!=null  and time!=''">
            and subString(time,1,7)=#{time}
        </if>
    </select>

    <!--修改实时房价-->
    <update id="updateRoomRealTimePrice" parameterType="com.goodsoft.hotel.domain.entity.guestRoom.RealTimeRoomPrice">
        update REALTIMEHOUSEPRICE set price=#{price} where typeid=#{typeid} and time=#{time}
    </update>

    <!--查询实时房价是否存在 -->
    <select id="joinRoomRealTimePrice" parameterType="com.goodsoft.hotel.domain.entity.guestRoom.RealTimeRoomPrice" resultType="java.lang.Integer">
        select count(1) from REALTIMEHOUSEPRICE where typeid=#{typeid} and time=#{time}
    </select>

    <!--删除错误房价-->
    <delete id="deleteErrorRoomRealTimePrice">
        delete from REALTIMEHOUSEPRICE where typeid ='date'
    </delete>

    <!--删除当天以前实时房价-->
    <delete id="deleteLastRealTimePrice" >
      delete from   REALTIMEHOUSEPRICE where time &lt; now();
    </delete>

    <delete id="deleteAllRealTimePrice">
        delete from   REALTIMEHOUSEPRICE
    </delete>




</mapper>